name: AI Code Reviewer & Issue Labeler

on:
  pull_request:
    types: [opened, synchronize]
  issues:
    types: [opened]

permissions: write-all

jobs:
  review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: AI Code Reviewer
        uses: Vendor-frontend/Vendor-repo-ai@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAIAPIKEY }}
          OPENAI_API_MODEL: "gpt-4"

  labeler:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo (required for gh CLI)
        uses: actions/checkout@v3

      - name: Extract Issue Info
        id: extract
        run: |
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_BODY=${{ github.event.issue.body }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Get Label from GPT
        id: gpt
        run: |
          echo "Calling GPT for labeling..."
          echo "Title: $ISSUE_TITLE"
          echo "Body: $ISSUE_BODY"

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAIAPIKEY }}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "model": "gpt-4o",
            "messages": [
            {
              "role": "system",
               "content": "Classify this GitHub issue into one label: bug, feature, enhancement, or question. Only return the label as one word, in lowercase."
            },
          {
            "role": "user",
            "content": "Issue title: $ISSUE_TITLE\n\nIssue body: $ISSUE_BODY"
          }
          ],
          "max_tokens": 10,
          "temperature": 0
          }
          EOF
          )

          echo "Raw GPT response:"
          echo "$RESPONSE"

          LABEL=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

          if [ "$LABEL" = "null" ] || [ -z "$LABEL" ]; then
            echo "âŒ No valid label returned by GPT."
            exit 1
          fi

          echo "LABEL=$LABEL" >> $GITHUB_ENV
          echo "âœ… Predicted label: $LABEL"

      - name: Apply label to issue
        run: |
          echo "ðŸ”– Labeling issue #${ISSUE_NUMBER} as '${LABEL}'"
          gh issue edit "$ISSUE_NUMBER" --add-label "$LABEL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
          LABEL: ${{ env.LABEL }}
